{% extends "base.html" %}

{% block content %}
<div id="content-block-div">
    <h1>Drive Free Space Over Time</h1>
    <div class="chart-container">
        <canvas id="freeSpaceChart"></canvas>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const ctx = document.getElementById('freeSpaceChart').getContext('2d');

        // Data provided by Jinja2
        const timeLabels = {{ time_labels | tojson }};
        const driveData = {{ drive_data | tojson }};
        const driveNames = {{ drive_letters | tojson }};
        const backgroundColors = [
            'rgba(75, 192, 192, 0.5)', // Teal
            'rgba(255, 99, 132, 0.5)', // Red
            'rgba(54, 162, 235, 0.5)', // Blue
            'rgba(255, 206, 86, 0.5)', // Yellow
            'rgba(153, 102, 255, 0.5)', // Purple
            'rgba(255, 159, 64, 0.5)'  // Orange
        ];
        const borderColors = [
            'rgba(75, 192, 192, 1)', // Teal
            'rgba(255, 99, 132, 1)', // Red
            'rgba(54, 162, 235, 1)', // Blue
            'rgba(255, 206, 86, 1)', // Yellow
            'rgba(153, 102, 255, 1)', // Purple
            'rgba(255, 159, 64, 1)'  // Orange
        ];

        const datasets = driveData.map((data, index) => ({
            label: driveNames[index],
            data: data.map(value => value / (1024 ** 4)), // Convert to TB for consistent Y-axis
            backgroundColor: backgroundColors[index % backgroundColors.length],
            borderColor: borderColors[index % borderColors.length],
            borderWidth: 1,
            fill: true
        }));

        new Chart(ctx, {
            type: 'line', // Line chart for stacked area visualization
            data: {
                labels: timeLabels,
                datasets: datasets
            },
            options: {
                plugins: {
                    title: {
                        display: true,
                        text: 'Remaining Free Space Over Time'
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function(tooltipItem) {
                                let value = tooltipItem.raw; // This will be in TB
                                let unit = 'TB';
                                if (value < 1) { // Convert to GB
                                    value *= 1024;
                                    unit = 'GB';
                                }
                                return `${tooltipItem.dataset.label}: ${value.toFixed(2)} ${unit}`;
                            }
                        }
                    }
                },
                responsive: true,
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Time'
                        }
                    },
                    y: {
                        stacked: true, // Enables stacking
                        title: {
                            display: true,
                            text: 'Free Space (TB)' // Y-axis always shows TB
                        }
                    }
                }
            }
        });
    });
</script>
{% endblock %}
