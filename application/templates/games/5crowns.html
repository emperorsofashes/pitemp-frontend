{% extends "base.html" %}

{% block header %}
    <link rel="shortcut icon" href="{{ url_for('static', filename='toolbox.ico') }}">
    <title>5 Crowns Score Tracker</title>
    <style>
        .score-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: var(--bs-body-bg, #fff);
            color: var(--bs-body-color, #000);
        }
        
        .score-table th, .score-table td {
            border: 1px solid var(--bs-border-color, #ddd);
            padding: 8px;
            text-align: center;
            background-color: var(--bs-body-bg, #fff);
            color: var(--bs-body-color, #000);
        }
        
        .score-table th {
            background-color: var(--bs-secondary-bg, #f2f2f2);
            font-weight: bold;
        }
        
        .wild-card {
            background-color: var(--bs-info-bg-subtle, #e6f3ff);
            font-weight: bold;
            min-width: 80px;
        }
        
        .player-name {
            background-color: var(--bs-secondary-bg, #f9f9f9);
            font-weight: bold;
        }
        
        .score-input {
            width: 60px;
            text-align: center;
            border: none;
            background: transparent;
            color: var(--bs-body-color, #000);
        }
        
        .score-input:focus {
            outline: 2px solid var(--bs-primary, #007bff);
            outline-offset: -2px;
        }
        
        .player-name-input {
            width: 100px;
            text-align: center;
            border: 1px solid var(--bs-border-color, #ccc);
            background: var(--bs-body-bg, #fff);
            color: var(--bs-body-color, #000);
        }
        
        .player-name-input:focus {
            outline: 2px solid var(--bs-primary, #007bff);
            outline-offset: -2px;
        }
        
        .setup-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid var(--bs-border-color, #ddd);
            border-radius: 5px;
            background-color: var(--bs-secondary-bg, #f9f9f9);
            color: var(--bs-body-color, #000);
        }
        
        .btn {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background-color: var(--bs-primary, #007bff);
            color: var(--bs-primary-text, white);
        }
        
        .btn:hover {
            background-color: var(--bs-primary-hover, #0056b3);
        }
        
        .btn-secondary {
            background-color: var(--bs-secondary, #6c757d);
        }
        
        .btn-secondary:hover {
            background-color: var(--bs-secondary-hover, #545b62);
        }
        
        /* Dark mode specific overrides */
        @media (prefers-color-scheme: dark) {
            .score-table {
                background-color: #212529;
                color: #ffffff;
            }
            
            .score-table th, .score-table td {
                background-color: #212529;
                color: #ffffff;
                border-color: #495057;
            }
            
            .score-table th {
                background-color: #343a40;
            }
            
            .wild-card {
                background-color: #0d6efd;
                color: #ffffff;
            }
            
            .player-name {
                background-color: #343a40;
            }
            
            .score-input {
                color: #ffffff;
            }
            
            .player-name-input {
                background-color: #212529;
                color: #ffffff;
                border-color: #495057;
            }
            
            .setup-section {
                background-color: #343a40;
                color: #ffffff;
                border-color: #495057;
            }
        }
        
        /* Ensure proper contrast for dark mode */
        .score-table tr:nth-child(even) {
            background-color: var(--bs-body-bg, #fff);
        }
        
        @media (prefers-color-scheme: dark) {
            .score-table tr:nth-child(even) {
                background-color: #1a1d20;
            }
        }
    </style>
{% endblock %}

{% block content %}

<div class="container">
    <h1>5 Crowns Score Tracker</h1>
    
    <div id="setupSection" class="setup-section">
        <h3>Game Setup</h3>
        <label for="playerCount">Number of Players:</label>
        <input type="number" id="playerCount" min="2" max="7" value="4" style="width: 60px; margin: 0 10px;">
        <button class="btn" onclick="setupGame()">Start Game</button>
    </div>
    
    <div id="gameArea" style="display: none;">
        <div style="margin-bottom: 20px;">
            <button class="btn btn-secondary" onclick="resetGame()">New Game</button>
        </div>
        <div id="scoreTableContainer"></div>
    </div>
</div>

<script>
let gameData = {
    players: [],
    rounds: [],
    currentRound: 0
};

const wildCards = ['3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];

function setupGame() {
    const playerCount = parseInt(document.getElementById('playerCount').value);
    if (playerCount < 2 || playerCount > 7) {
        alert('Please enter a number between 2 and 7');
        return;
    }
    
    gameData.players = [];
    gameData.rounds = [];
    gameData.currentRound = 0;
    
    for (let i = 1; i <= playerCount; i++) {
        gameData.players.push({
            id: i,
            name: `Player${i}`,
            totalScore: 0
        });
    }
    
    // Create initial rounds (3 through King)
    for (let i = 0; i < wildCards.length; i++) {
        gameData.rounds.push({
            roundNumber: i + 1,
            wildCard: wildCards[i],
            scores: new Array(playerCount).fill('')
        });
    }
    
    document.getElementById('setupSection').style.display = 'none';
    document.getElementById('gameArea').style.display = 'block';
    renderScoreTable();
}

function resetGame() {
    // Check if there's any data to lose
    let hasData = false;
    for (let round of gameData.rounds) {
        for (let score of round.scores) {
            if (score !== '' && score !== 0) {
                hasData = true;
                break;
            }
        }
        if (hasData) break;
    }
    
    // Show confirmation if there's data
    if (hasData) {
        if (!confirm('Are you sure you want to start a new game? This will clear all current scores.')) {
            return; // User cancelled
        }
    }
    
    gameData = {
        players: [],
        rounds: [],
        currentRound: 0
    };
    document.getElementById('gameArea').style.display = 'none';
    document.getElementById('setupSection').style.display = 'block';
    document.getElementById('playerCount').value = 4;
}

function renderScoreTable() {
    const container = document.getElementById('scoreTableContainer');
    let html = '<table class="score-table">';
    
    // Header row
    html += '<tr>';
    html += '<th class="wild-card">Round</th>';
    for (let i = 0; i < gameData.players.length; i++) {
        html += `<th class="player-name">
            <input type="text" class="player-name-input" value="${gameData.players[i].name}" 
                   onchange="updatePlayerName(${i}, this.value)">
        </th>`;
    }
    html += '</tr>';
    
    // Score rows
    for (let roundIndex = 0; roundIndex < gameData.rounds.length; roundIndex++) {
        const round = gameData.rounds[roundIndex];
        html += `<tr>
            <td class="wild-card">${round.wildCard}</td>`;
        
        for (let playerIndex = 0; playerIndex < gameData.players.length; playerIndex++) {
            html += `<td>
                <input type="number" class="score-input" 
                       value="${round.scores[playerIndex] || ''}" 
                       onchange="updateScore(${roundIndex}, ${playerIndex}, this.value)"
                       placeholder="0">
            </td>`;
        }
        html += '</tr>';
    }
    
    // Totals row
    html += '<tr style="background-color: #e6e6e6; font-weight: bold;">';
    html += '<td class="wild-card">Total</td>';
    for (let i = 0; i < gameData.players.length; i++) {
        html += `<td id="total-${i}">0</td>`;
    }
    html += '</tr>';
    
    html += '</table>';
    container.innerHTML = html;
    
    calculateTotals();
}

function updatePlayerName(playerIndex, newName) {
    gameData.players[playerIndex].name = newName;
}

function updateScore(roundIndex, playerIndex, value) {
    gameData.rounds[roundIndex].scores[playerIndex] = value === '' ? '' : parseInt(value) || 0;
    calculateTotals();
}

function calculateTotals() {
    for (let playerIndex = 0; playerIndex < gameData.players.length; playerIndex++) {
        let total = 0;
        for (let roundIndex = 0; roundIndex < gameData.rounds.length; roundIndex++) {
            const score = gameData.rounds[roundIndex].scores[playerIndex];
            if (score !== '' && !isNaN(score)) {
                total += parseInt(score);
            }
        }
        gameData.players[playerIndex].totalScore = total;
        document.getElementById(`total-${playerIndex}`).textContent = total;
    }
}


// Initialize the page
document.addEventListener('DOMContentLoaded', function() {
    // Auto-setup with default values for demonstration
    // setupGame();
});
</script>

{% endblock %}
