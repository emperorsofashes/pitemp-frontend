{% extends "base.html" %}

{% block header %}
    <link rel="shortcut icon" href="{{ url_for('static', filename='games.ico') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='games.css') }}">
    <title>Books and Runs Score Tracker</title>
{% endblock %}

{% block content %}

<div class="container">
    <h1>Books and Runs Score Tracker</h1>
    <p><em>Based on Continental Rummy rules</em></p>
    
    <div id="setupSection" class="setup-section">
        <h3>Game Setup</h3>
        <label for="playerCount">Number of Players:</label>
        <input type="number" id="playerCount" min="2" max="8" value="4" style="width: 60px; margin: 0 10px;">
        <button class="btn" onclick="setupGame()">Start Game</button>
    </div>
    
    <div id="gameArea" style="display: none;">
        <div style="margin-bottom: 20px;">
            <button class="btn btn-secondary" onclick="resetGame()">New Game</button>
        </div>
        <div id="scoreTableContainer"></div>
    </div>
</div>

<script>
let gameData = {
    players: [],
    rounds: [],
    currentRound: 0
};

// Continental Rummy hands - 7 rounds total
const roundRequirements = [
    { round: 1, description: "Two books", cards: 6 },
    { round: 2, description: "One book & one run", cards: 7 },
    { round: 3, description: "Two runs", cards: 8 },
    { round: 4, description: "Three books", cards: 9 },
    { round: 5, description: "Two books & one run", cards: 10 },
    { round: 6, description: "Two runs & one book", cards: 11 },
    { round: 7, description: "Three runs", cards: 12 }
];

function setupGame() {
    const playerCount = parseInt(document.getElementById('playerCount').value);
    if (playerCount < 2 || playerCount > 8) {
        alert('Please enter a number between 2 and 8');
        return;
    }
    
    gameData.players = [];
    gameData.rounds = [];
    gameData.currentRound = 0;
    
    for (let i = 1; i <= playerCount; i++) {
        gameData.players.push({
            id: i,
            name: `Player${i}`,
            totalScore: 0
        });
    }
    
    // Create all 7 rounds
    for (let i = 0; i < roundRequirements.length; i++) {
        gameData.rounds.push({
            roundNumber: i + 1,
            requirement: roundRequirements[i].description,
            cardsNeeded: roundRequirements[i].cards,
            scores: new Array(playerCount).fill('')
        });
    }
    
    // Save to localStorage
    saveGameToStorage();
    
    document.getElementById('setupSection').style.display = 'none';
    document.getElementById('gameArea').style.display = 'block';
    renderScoreTable();
}

function resetGame() {
    // Check if there's any data to lose
    let hasData = false;
    for (let round of gameData.rounds) {
        for (let score of round.scores) {
            if (score !== '' && score !== 0) {
                hasData = true;
                break;
            }
        }
        if (hasData) break;
    }
    
    // Show confirmation if there's data
    if (hasData) {
        if (!confirm('Are you sure you want to start a new game? This will clear all current scores.')) {
            return; // User cancelled
        }
    }
    
    gameData = {
        players: [],
        rounds: [],
        currentRound: 0
    };
    
    // Clear localStorage
    localStorage.removeItem('booksRunsGame');
    
    document.getElementById('gameArea').style.display = 'none';
    document.getElementById('setupSection').style.display = 'block';
    document.getElementById('playerCount').value = 4;
}

function renderScoreTable() {
    const container = document.getElementById('scoreTableContainer');
    let html = '<table class="score-table">';
    
    // Header row
    html += '<tr>';
    html += '<th class="wild-card">Round</th>';
    for (let i = 0; i < gameData.players.length; i++) {
        html += `<th class="player-name">
            <input type="text" class="player-name-input" value="${gameData.players[i].name}" 
                   onchange="updatePlayerName(${i}, this.value)">
        </th>`;
    }
    html += '</tr>';
    
    // Score rows
    for (let roundIndex = 0; roundIndex < gameData.rounds.length; roundIndex++) {
        const round = gameData.rounds[roundIndex];
        html += `<tr>
            <td class="wild-card" title="Need ${round.cardsNeeded} cards to go down">${round.requirement}</td>`;
        
        for (let playerIndex = 0; playerIndex < gameData.players.length; playerIndex++) {
            html += `<td>
                <input type="number" class="score-input" 
                       value="${round.scores[playerIndex] || ''}" 
                       onchange="updateScore(${roundIndex}, ${playerIndex}, this.value)"
                       placeholder="0"
                       title="Enter positive score if you went out, negative if you didn't">
            </td>`;
        }
        html += '</tr>';
    }
    
    // Totals row
    html += '<tr style="background-color: #e6e6e6; font-weight: bold;">';
    html += '<td class="wild-card">Total</td>';
    for (let i = 0; i < gameData.players.length; i++) {
        html += `<td id="total-${i}">0</td>`;
    }
    html += '</tr>';
    
    html += '</table>';
    container.innerHTML = html;
    
    calculateTotals();
}

function updatePlayerName(playerIndex, newName) {
    gameData.players[playerIndex].name = newName;
    saveGameToStorage();
}

function updateScore(roundIndex, playerIndex, value) {
    gameData.rounds[roundIndex].scores[playerIndex] = value === '' ? '' : parseInt(value) || 0;
    calculateTotals();
    saveGameToStorage();
}

function calculateTotals() {
    for (let playerIndex = 0; playerIndex < gameData.players.length; playerIndex++) {
        let total = 0;
        for (let roundIndex = 0; roundIndex < gameData.rounds.length; roundIndex++) {
            const score = gameData.rounds[roundIndex].scores[playerIndex];
            if (score !== '' && !isNaN(score)) {
                total += parseInt(score);
            }
        }
        gameData.players[playerIndex].totalScore = total;
        document.getElementById(`total-${playerIndex}`).textContent = total;
    }
}

function saveGameToStorage() {
    try {
        localStorage.setItem('booksRunsGame', JSON.stringify(gameData));
    } catch (e) {
        console.warn('Could not save game to localStorage:', e);
    }
}

function loadGameFromStorage() {
    try {
        const saved = localStorage.getItem('booksRunsGame');
        if (saved) {
            const parsed = JSON.parse(saved);
            // Validate the saved data structure
            if (parsed.players && parsed.rounds && Array.isArray(parsed.players) && Array.isArray(parsed.rounds)) {
                gameData = parsed;
                return true;
            }
        }
    } catch (e) {
        console.warn('Could not load game from localStorage:', e);
    }
    return false;
}

// Initialize the page
document.addEventListener('DOMContentLoaded', function() {
    // Try to load existing game from localStorage
    if (loadGameFromStorage() && gameData.players.length > 0) {
        // Show the game area with loaded data
        document.getElementById('setupSection').style.display = 'none';
        document.getElementById('gameArea').style.display = 'block';
        renderScoreTable();
    }
    // If no saved game, show setup screen
});
</script>

{% endblock %}
